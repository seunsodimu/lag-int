# Public directory routing with optional /lag-int prefix
RewriteEngine On

# Preserve Authorization header (critical for API key authentication)
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

# IMPORTANT: Serve actual files directly, never rewrite them
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# If the request starts with /lag-int/public/ or /public/, strip it so files resolve in public/
RewriteRule ^(lag-int/)?public/(.*)$ $2 [L,QSA]

# If the request starts with /lag-int, strip the prefix
RewriteRule ^lag-int/?$ index.php [L,QSA]
RewriteRule ^lag-int/(.*)$ $1 [L,QSA]

# Front controller fallback: send non-file/non-dir requests to index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [L,QSA]

# Basic protections
<FilesMatch "\.(log|conf|sql|env)$">
  Require all denied
</FilesMatch>

# Optional security headers
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options nosniff
  Header always set X-Frame-Options DENY
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Pass Authorization header to PHP
<IfModule mod_php.c>
  SetEnvIf Authorization .+ HTTP_AUTHORIZATION=$0
</IfModule>

# For PHP-FPM (common in Docker)
<IfModule mod_fcgid.c>
  SetEnvIf Authorization .+ HTTP_AUTHORIZATION=$0
</IfModule>